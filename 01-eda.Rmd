# Exploratory Data Analysis

## Getting Started With R
 
### Installing R

For this class, you will be using R Studio to complete statistical analyses on your computer. 

To begin using R Studio, you will need to install "R" first and then install "R Studio" on your computer.

***Step 1: Download R*** \
(a) Visit [https://www.r-project.org/](https://www.r-project.org/) \
(b) Click **CRAN** under **Download**
(c) Select any of the mirrors \
(d) Click the appropriate link for your type of system (Mac, Windows, Linux) \
(e) Download R on this next page. \
(For Windows, this will say **install R for the first time**. For Mac, this will be under **Latest release** and will be something like **R-4.1.0.pkg** -- the numbers may differ depending on the most recent version) \
(f) Install R on your computer \
       
***Step 2: Download R Studio*** \
(a) Visit [https://www.rstudio.com/products/rstudio/download/#download](https://www.rstudio.com/products/rstudio/download/#download) \
(b) Click to download \
(c) Install R Studio on your computer \

***Step 3: Verify R Studio is working*** \
(a)  Open R Studio \
(b) Let's enter a small dataset and calculate the average to make sure everything is working correctly. \
(c) In the console, type in the following dataset of Sammy Sosa's season home run totals from 1998--2002: \

```{r}
sosa.HR <- c(66,63,50,64,49)
```

(d) In the console, calculate the average season home run total for Sammy Sosa between 1998--2002: \

```{r}
mean(sosa.HR)
```

\noindent (e) Did you find Slammin' Sammy's average home run total from 1998--2002 was 58.4? If so, you should be set up correctly!

### Some R Basics

For the following examples, let's consider Peyton Manning's career with the Denver Broncos. In his four seasons with the Broncos, Manning's passing yard totals were: 4659, 5477, 4727, 2249. Let's enter this data into R. To enter a vector of data, use the **c()** function.

```{r}
peyton <- c(4659, 5477, 4727, 2249)
```

To look at the data you just put in the variable *peyton*, type *peyton* into the console and press enter.

```{r}
peyton
```

Some basic function for calculating summary statistics include **summary**, **mean()**, **median()**, **var()**, and **sd()**.

```{r}
summary(peyton)
mean(peyton)
sd(peyton)
```

R allows you to install additional packages (collections of functions) that aren't offered in the base version of R. To install a package, use **install.packages(<name_of_package>)** and to load a package, use **library(<name_of_package>)**.

One package that we will use frequently is **tidyverse**. This package includes several other packages and functions such as **ggplot** (plotting function), **dplyr** (data manipulation package), and **stringr** (string manipulation package).

```{r,message=F,include=F}
r = getOption("repos")
r["CRAN"] = "http://cran.us.r-project.org"
options(repos = r)
```

```{r,message=F,eval=F}
install.packages("tidyverse")
library("tidyverse")
```

You will also need to know how to load datasets from files. For this class, we will typically provide data files is .csv format.

Here is how to load a file:
```{r load, message=F}
# load readr package and load example dataset
library(readr)
NFL_2021_Team_Passing <- read_csv("data/NFL_2021_Team_Passing.csv")

# we can look at the header (first few entries) using "head()"
head(NFL_2021_Team_Passing)
```

\newpage

## Descriptive Statistics

### Definitions

::: {.definition}
A ***population*** is a well-defined complete collection of objects.
:::

::: {.definition}
A ***sample*** is a subset of the population.
:::

::: {.example}
Suppose we are interested in studying Peyton's Manning's season passing yards totals. How could you define the population and what is one possible sample?
::: 

\
\
\
\
\



::: {.definition}
***Quantitative data*** is numeric data or numbers. It can be broken into two further categories: discrete and continuous data. 
:::

::: {.definition}
***Discrete data*** is quantitative data with a finite or countably infinite number of values. 
:::

::: {.definition}
***Continuous data*** is quantitative data with an uncountably infinite number of values or data taken from an interval.
:::

::: {.example}
What are possible discrete and continuous data associated with Peyton Manning?
:::

\
\
\
\
\

::: {.definition}
***Qualitative data*** refers to names, categories, or descriptions. It can also be broken down into
two further categories, nominal data and ordinal data.
:::

::: {.definition}
***Nominal data*** is qualitative data with no natural ordering.
:::

::: {.definition}
***Ordinal data*** is qualitative data with a natural ordering.
:::
 
::: {.example}
What are possible nominal and ordinal data associated with Peyton Manning?
:::

\
\
\
\
\

-----


### Descriptive Statistics

While we will learn about some descriptive statistics that are unique to specific sports, there are some descriptive statistics that are frequently used in many applications.

#### Descriptive Statistics for Quantitative Data

There are different descriptive statistics depending on the type of data you are analyzing. We will begin by looking at descriptive statistics for quantitative data.

To begin, let $x_1, x_2, \ldots, x_n$ represent a numerical dataset with a sample of size $n$, where $x_i$ is the $i^\text{th}$ value in the dataset.

::: {.definition}
The ***sum*** of the data values is given by: $\sum_{i=1}^n x_i = x_1 + x_2 + \ldots + x_n$
:::

::: {.definition}
The ***sample mean*** (or sample average), $\bar{x}$, of the numerical dataset is given by $\bar{x} = \frac{1}{n} \sum_{i=1}^n x_i$
:::

::: {.definition}
The ***population mean*** (or population average), $\mu$, is the mean value for the entire population.
:::

The mean can be thought of as a measure of center or more generally, a measure of location.

::: {.example}
Recall that Peyton Manning's season passing yards total while with the Broncos were: 4659, 5477, 4727, 2249. Calculate the sample mean of these values.
:::

\
\
\
\
\

```{r mean}
# Calculate the sample of Peyton Manning's passing yards season totals with Colts
peyton.broncos <- c(4659, 5477, 4727, 2249)
mean(peyton.broncos)
```

In sports statistics, we often have to choose between using a descriptive statistic that summarizes a quantity versus a descriptive statistic that summarizes a rate. For instance, in basketball, we can compare two players based on how many points they score in a game (total quantity) or we can compare two players based on how many points per minute played (rate statistic). Many applications in sports analytics focus more on rate statistics rather than quantity statistics. Why?

We can measure the spread or variability of a dataset using *variance* and *standard devatiation*.

::: {.definition}
The ***sample variance***, $s^2$, of the numerical dataset is a measure of spread and is given by $s^2 = \frac{1}{n-1}\sum_{i=1}^n (x_i - \bar{x})^2$
:::

::: {.definition}
The ***sample standard deviation***, $s$, of the numerical dataset is a measure of spread and is given by $s = \sqrt{s^2} = \sqrt{\frac{1}{n-1}\sum_{i=1}^n (x_i - \bar{x})^2}$
:::

::: {.definition}
The ***population variance***, $\sigma^2$, is the variance for an entire population.
:::

::: {.definition}
The ***population standard deviation***, $\sigma$, is the standard deviation for an entire population.
:::

We often prefer to work with standard deviations as a measure of spread as opposed to variance because standard deviations are given in our original units.

```{r var}
# Calculate the variance and standard deviation of Peyton Manning's passing yards
# season totals with Broncos
var(peyton.broncos) # units: yards^2
sd(peyton.broncos) # units: yards
```

::: {.definition}
The **sample median**, $\tilde{x}$, of a numerical dataset is the middle value when the data are ordered from smallest to largest. In other words, let $x_1, x_2, \ldots, x_n$ be the (unordered) dataset and let $x_{(1)},x_{(2)}, \ldots, x_{(n)}$ be the same dataset but ordered from smallest to largest. If $n$ is odd, then $\tilde{x} = x_{(n+1)/2}$ and if $n$ is even, then $\tilde{x} = \frac{1}{2} \cdot \left[x_{\left(\frac{n}{2}\right)} + x_{\left(\frac{n+1}{2}\right)}\right]$.
:::


::: {.example}
Calculate the sample median of Peyton Manning's season passing yards total while with the Colts (3739, 4135, 4413, 4131, 4200, 4267, 4557, 3747, 4397, 4040, 4002, 4500, 4700). 
:::

\
\
\
\
\

Like sample mean, sample median is a measure of center. It gives you an idea of where the ``middle" of your dataset is. 

We can calculate sample mean and sample median in R as follows:

```{r median}
# Calculate the median of Peyton Manning's passing yards season totals with 
# Broncos and Colts
peyton.colts <- c(3739, 4135, 4413, 4131, 4200, 4267, 4557, 3747, 4397, 4040, 
                  4002, 4500, 4700)
median(peyton.broncos)
median(peyton.colts)
```

:::{.definition}
A ***percentile*** is a measure of relative standing. The $p^\text{th}$ percentile is the number where at least
p\% of the data values are less than or equal to this number.
:::

:::{.definition}
A ***quantile*** is a measure of relative standing and are the cut points for breaking a distribution of values into equal sized bins.
:::

:::{.definition}
A ***quartile*** is a measure of relative standing and are the cut points for breaking a distribution of values into four equal parts.
:::


```{r perc}
# Calculate the 10th and 90th percentile of Peyton Manning's passing yards season
# totals with Colts
quantile(peyton.colts,0.10)
quantile(peyton.colts,0.90)
quantile(peyton.colts,c(0.1,0.9))
```

**Special percentiles:** \
1. 25th percentile = 1st quartile = $Q_1$ \
2. 50th percentile = 2nd quartile = $Q_2$ = $\tilde{x}$ \
3. 75th percentile = 3rd quartile = $Q_3$ \

:::{.definition}
***Range*** is a measure of spread, measures the full width of a dataset, and is given by: $Range = Max - Min$.
:::

:::{.definition}
***Interquartile range*** is a measure of spread, measures the width of the middle 50\% of a dataset, and is given by: $IQR = Q_3 - Q_1$. 
:::

:::{.definition}
A ***five number summary*** describes the center, spread, and edges of a dataset and is given by: $(Min,Q_1,Q_2,Q_3,max)$.
:::

```{r iqr}
summary(peyton.colts)
quantile(peyton.colts,c(0,0.25,0.5,0.75,1))
```

#### Descriptive Statistics for Qualitative Data

In sports statistics, we also encounter qualitative (categorical) data which is names or labels which has its own descriptive statistics.


To begin, let $x_1, x_2, \ldots, x_n$ represent a categorical dataset with a sample of size $n$, where $x_i$ is the $i^\text{th}$ value in the dataset.

::: {.definition}
The ***proportion*** of sampled data that fall into a category is given by: $p = \frac{\#\text{ in category}}{\#\text{ total}}$
:::

''Proportion" and "Probability" are often used interchangeably. Both have a minimum value of 0 and a maximum value of 1.

::: {.definition}
The ***percentage*** of sampled data that fall into a category is given by: $P\% = 100 \cdot p = 100 \cdot \frac{\#\text{ in category}}{\#\text{ total}}$
:::

Percentages in this context can have a minimum value of 0\% and a maximum value of 100\%.

::: {.example}
In 2014, Peyton Manning started as quarterback for the Denver Broncos. The result of the Broncos' 16-game season was: \
Win, Win, Loss, Win, Win, Win, Win, Loss, Win, Loss, Win, Win, Win, Win, Loss, Win

Calculate the proportion and percentage of Broncos' winning games in 2014.
:::

\
\
\
\
\

```{r prop}
broncos2014 <- c("Win", "Win", "Loss", "Win", "Win", "Win", "Win", "Loss", "Win",
                 "Loss", "Win", "Win", "Win", "Win", "Loss", "Win")
broncos.prop <- sum(broncos2014 == "Win")/length(broncos2014); broncos.prop
broncos.perc <- 100*broncos.prop; broncos.perc
```

We can also build a frequency table that summarizes the categories and their occurrences using **table()** in R. Note that **table()** works for quantitative and qualitative data.

```{r freq}
table(broncos2014)
```

\newpage

## Visualizations

Conveying information visually is also an important part in providing a description of a dataset.

R provides some basic plotting functions such as **plot**, **hist**, and **barplot**. These plotting functions are simple and not always very clean looking.

In this class, we will use analogous plotting functions in **ggplot2** that are much improved plotting functions.

If you have already installed the **tidyverse** package, it should have also installed the **ggplot2** package.

```{r setup1}
# You have likely already installed the tidyverse package but if not, use the following command without the "#"
# install.packages("tidyverse")

# Load the tidyverse package (which includes ggplot2)
library(tidyverse)
```

Let's load the file ``NFL_2021_Team_Passing.csv" which contains [NFL Team Passing Statistics, 2021](https://www.pro-football-reference.com/years/2021/index.htm#passing)

```{r load2, message=F}
library(readr)
NFL_2021_Team_Passing <- read_csv("data/NFL_2021_Team_Passing.csv")
```

Histograms are one of the most common and basic ways to visualize a dataset's distribution of values. To make a histogram, you will use **ggplot** and **geom_histogram**.

:::{.example}
Create a histogram of the NFL Team Passing Yards in 2021.

```{r hist, message=F}
NFL_2021_Team_Passing %>% ggplot(aes(x=Yds)) + geom_histogram()
```

Notice how **%>%** is used to **pipe** the dataset into ggplot. This is using the pipe function from the **dplyr** package.

By default, **geom_histogram** uses 30 bins but this is customizable. Let's make the bins have a width of 200.

All good visualizations have good labels. Let's improve the axis labels and give the figure a title.

```{r hist2}
NFL_2021_Team_Passing %>% ggplot(aes(x=Yds)) + 
  geom_histogram(binwidth = 200) +
  labs(x="Team Passing Yards",y="Team Passing Touchdowns",title="NFL Team Passing Yards, 2021")
```

We also have numerous options to change the appearance of plots when using **ggplot**. Let's change the bins color to *blue* and change the bin borders to *white*.

```{r hist3}
NFL_2021_Team_Passing %>% ggplot(aes(x=Yds)) + 
  geom_histogram(color = "white", fill = "blue", binwidth = 200) +
  labs(x="Team Passing Yards", y="Team Passing Touchdowns", title="NFL Team Passing Yards, 2021")
```
:::

We can also create bar plots using ggplot using the **geom_bar** function.

:::{.example}
Create a bar plot with teams on the horizontal axis and passing touchdowns on the vertical axis.

```{r bar}
NFL_2021_Team_Passing %>% ggplot(aes(x=Tm,y=Yds)) +
  geom_bar(stat="identity")
```

The team labels are a complete mess. Let's fix this and make some adjustments to the axis labels and figure title.

```{r bar2}
NFL_2021_Team_Passing %>% ggplot(aes(x=Tm,y=Yds)) +
  geom_bar(stat="identity") + 
  labs(x="Team Passing Yards", y="Team Passing Touchdowns", 
       title="NFL Team Passing Yards, 2021") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

We can flip this graph if we like as well. Note that when we flip the graph, our labels get in reverse ordering, so this can be fixed using **fct_rev()** which is part of the **forcats** package.

```{r bar3}
NFL_2021_Team_Passing %>% 
  ggplot(aes(x=fct_rev(Tm),y=Yds)) +
  geom_bar(stat="identity") +
  labs(x="Team Passing Yards",y="Team Passing Touchdowns",title="NFL Team Passing Yards, 2021") +
  coord_flip()
```

:::

Another common and useful visualization is a scatterplot which shows the relationship between two numeric variable. In ggplot, you use **geom_point()**.

:::{.example}
Create a scatterplot of Team Passing Yards and Team Passing Touchdowns from the NFL 2021 dataset.

```{r scatter1}
NFL_2021_Team_Passing %>%
  ggplot(aes(x=Yds,y=TD,label=Tm)) + 
  geom_point() +
  labs(x="Team Passing Yards",y="Team Passing Touchdowns",title="NFL Team Passing Yards, 2021")
```

We may want to include team labels on this plot, however, it can get messy very quickly with a lot of points. 

```{r scatter2}
NFL_2021_Team_Passing %>%
  ggplot(aes(x=Yds,y=TD,label=Tm)) + 
  geom_point() +
  labs(x="Team Passing Yards",y="Team Passing Touchdowns",title="NFL Team Passing Yards, 2021") +
  geom_text()
```

Many sports leagues have around 30 teams, so a clean scatterplot with labels can be tricky to make. Here are some options below.

```{r scatter3}
# install ggrepel package
library(ggrepel)
NFL_2021_Team_Passing %>%
  ggplot(aes(x=Yds,y=TD,label=Tm)) + 
  geom_point() +
  labs(x="Team Passing Yards",y="Team Passing Touchdowns",title="NFL Team Passing Yards, 2021") +
  geom_text_repel()
```

```{r scatter4}
NFL_2021_Team_Passing$Abbr <- c("TB","LAC","DAL","KC","LAR","LV","CIN","GB","BUF","AZ","MN","SF",
                                "BAL","NE","PIT","ATL","MIA","DET","DEN","NYJ","WAS","JAC","SEA",
                                "TEN","PHI","IND","CLE","HOU","CAR","CHI","NYG","NO")
NFL_2021_Team_Passing %>%
  ggplot(aes(x=Yds,y=TD,label=Abbr)) + 
  geom_point() +
  labs(x="Team Passing Yards",y="Team Passing Touchdowns",title="NFL Team Passing Yards, 2021") +
  geom_text_repel(box.padding = 0.3) 
```


:::

\newpage

## Baseball

\newpage

## Football

\newpage

## Basketball

### Four Factors

Tibbles are a type of data frame supported by the `tidyverse` package. The following tibble contains data from a Mountain West tournament game played between the CSU and Wyoming women's basketball teams during the 2021-2022 season, which CSU won 51-38. [(Here's the link to the box score on the CSU athletics website.)](https://csurams.com/sports/womens-basketball/stats/2021-22/wyoming/boxscore/16095)

```{r four factors}
library("tibble")

basketball_data <- tibble(team = c("CSU","WYO"), FG = c(14,15), FGA = c(48,60), THREEP = c(5,4), FT = c(10,4), FTA = c(14,4), ORB = c(2,14), DRB = c(31,30), TOV = c(5,12)); basketball_data
```

This tibble contains all the data needed to calculate the *Four Factors*. The Four Factors of a basketball game are statistics formulated by Dean Oliver, former Director of Quantitative Analysis for the Denver Nuggets (among other roles). These statistics are also promoted by sports data platforms like Hudl.com.

The first is **Effective Field Goal Percentage**, commonly abbreviated eFG%. The formula is as follows:

$eFG\% = \frac{FG\ +\ 0.5(3P)}{FGA}$

Secondly, **Turnover Percentage** (TOV%) is calculated as:

$TOV\% = \frac{TOV}{FGA\ +\ 0.44(FTA)\ +\ TOV}$

Next, **Rebounding Percentage** (ORB%) is computed as:

$ORB\% = \frac{ORB}{ORB\ +\ Opponent\ DRB}$

Finally, the **Free Throw Factor** is found using:

$FT\ factor = \frac{FT}{FGA}$

Note: You do not have to know these formulas for the test. They are just used for this example.

Let's calculate the values of eFG%, TOV%, and Free Throw Factor for both CSU and Wyoming and add them as new columns in the tibble using the `add_column` function.

```{r four factors 2}
attach(basketball_data)
eFG <- round((FG + .5 * THREEP)/FGA, 3)
TOVPCT <- round(TOV / (FGA + .44 * FTA + TOV), 3)
FTFACTOR <- round(FT/FGA, 3)

basketball_data %>% add_column(eFG, TOVPCT, FTFACTOR)
```

\newpage

## Soccer

To begin, let's go over a couple of basic summary statistics specific to soccer that will be necessary to understand for the following examples.

-   **Shots (SH)** represent all shots taken by a team throughout the game. This is simply an attempt by a player to shoot the ball toward the net, even if they miss or the shot is saved (Rookie Road).

-   **Shots on Goal (SOG)** represent all shots that would have gone into the goal if not saved by a defender or goalkeeper (Rookie Road).

-   **Expected Goals (xG)** "indicates how many goals a team could have expected to score based on the quantity and quality of chances that they created in a match" (Tippett 2019, 4).

-   **Assist (A)** occur when a player passes the ball to someone, and the next shot results in a goal.

-   **Possession** refers to the percentage of time a team had control of the ball during a game.

These definitions come from www.rookieroad.com and "The Expected Goals Philosophy" by James Tippett.

To learn more about expected goals, check out [this YouTube video](https://www.youtube.com/watch?v=w7zPZsLGK18&list=PL9Az6mi38hv__afKnHR1AKjpcDIw_0qqT){.uri}.

### Bar Plot

Now that we have an understanding of some basic shooting statistics, let us go through some EDA examples. For this first example, we will need to install the "worldfootballR" package.

```{r}
library(worldfootballR)
```

Next we will look at some data specific to LaLiga, which is a soccer league in the men's top professional soccer division.

```{r,eval=F,message=F}
# Get "Squad Standard Stats" Data
big5_2021_stats <- fb_big5_advanced_season_stats(season_end_year = 2021, stat_type = "standard", team_or_player = "team")
liga_2021_stats <- big5_2021_stats[which((big5_2021_stats$Comp == "La Liga")),]
```

```{r, echo=F,message=F}
liga_2021_stats <- read_csv("data/liga_2021_stats.csv")
```

```{r}
# Create visual for each team's goals per game
team_goals_viz <- ggplot(data = liga_2021_stats[which(liga_2021_stats$Team_or_Opponent == "team"),], 
                         aes(x = Squad, y = Gls_Per)) +
  geom_bar(stat = "identity")
team_goals_viz
```

This plot is a good starting point, but still looks pretty messy. Let's add a title, change the axis titles, and rotate the axis labels so they are not overlapping over one another.

```{r}
team_goals_viz <- team_goals_viz +
  xlab("Team") +
  ylab("Goals Per Game") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggtitle("Goals Per Game by Team")
team_goals_viz
```

This is already looking a lot better. Now, we will add the goals scored per game *against* each team. Why is this of interest? Well, at first glance, Barcelona seems like a pretty impressive team, as they score more goals per game than any other team in the league. However, what if they also have more goals scored against them than any other team in the league? This could be important context, so we will include it in the graph below.

```{r}
all_goals_viz <- ggplot(data = liga_2021_stats, aes(x = Squad, y = Gls_Per)) +
  geom_bar(stat = "identity", aes(fill = Team_or_Opponent), position = "stack") +
  xlab("Team") +
  ylab("Goals Per 90 Minutes") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggtitle("Goals Per Game by Team")
all_goals_viz
```

This is looking pretty good, but let's clean it up just a bit by changing the legend title and labels.

```{r}
all_goals_viz +
  scale_fill_discrete(name = "Team or Opponent", labels = c("Opponent","Team"))

```

What does this graph show us? Well, we are able to see the average number of goals scored for and against each team per game. It looks like Barcelona is scoring a lot more goals than they are letting be scored against them, while other teams like Valladolid tend to have a higher proportion of goals scored for the opposing team.

### Scatter Plot

In addition to simply knowing the average actual number of goals scored for and against each team per game, we may be interested in how this compares to the expected number of goals scored per game, as well.

```{r, warning=F, message=F}
library(ggExtra)
act_exp_viz <- ggplot(data = liga_2021_stats, aes(x = xG_Per, y = Gls_Per, label = Squad)) +
  geom_point() +
  scale_x_continuous(limits = c(0.75,2.25)) +
  scale_y_continuous(limits = c(0.75,2.25)) +
  ggtitle("Expected vs. Actual Goals Per Game") +
  xlab("Expected Goals Per Game") +
  ylab("Actual Goals Per Game") +
  geom_smooth(method = "lm", se = FALSE) +
  theme(aspect.ratio = 2/2)
ggMarginal(act_exp_viz, type = "density")

```

As you can see, we fit a line to the data. At first glance, it seems to have a positive slope slightly greater than 1. What does this mean in the scenario of actual and expected goals per game?

### Density Ridges Plot

At first glance, it seems that actual goals scored per game do not differ greatly from expected goals per game. Let us look at some density plots for actual and expected goals per game for five of the top teams in LaLiga over the last four seasons. These are the top five teams as of June 21st, 2022 on www.foxsports.com.


```{r, message=F, warning=F}
library(ggridges)

# Get "Squad Standard Stats" data for the last four seasons
top_liga_2021_stats <- read_csv("data/laliga21.csv")
top_liga_2020_stats <- read_csv("data/laliga20.csv")
top_liga_2019_stats <- read_csv("data/laliga19.csv")
top_liga_2018_stats <- read_csv("data/laliga18.csv")

top_liga_2021_stats <- top_liga_2021_stats[which(top_liga_2021_stats$Squad == "Real Madrid"|
                                           top_liga_2021_stats$Squad == "Villarreal"|
                                           top_liga_2021_stats$Squad == "Barcelona"|
                                           top_liga_2021_stats$Squad == "Levante"|
                                           top_liga_2021_stats$Squad == "Betis"),]
top_liga_2020_stats <- top_liga_2020_stats[which(top_liga_2020_stats$Squad == "Real Madrid"|
                                           top_liga_2020_stats$Squad == "Villarreal"|
                                           top_liga_2020_stats$Squad == "Barcelona"|
                                           top_liga_2020_stats$Squad == "Levante"|
                                           top_liga_2020_stats$Squad == "Betis"),]
top_liga_2019_stats <- top_liga_2019_stats[which(top_liga_2019_stats$Squad == "Real Madrid"|
                                           top_liga_2019_stats$Squad == "Villarreal"|
                                           top_liga_2019_stats$Squad == "Barcelona"|
                                           top_liga_2019_stats$Squad == "Levante"|
                                           top_liga_2019_stats$Squad == "Betis"),]
top_liga_2018_stats <- top_liga_2018_stats[which(top_liga_2018_stats$Squad == "Real Madrid"|
                                           top_liga_2018_stats$Squad == "Villarreal"|
                                           top_liga_2018_stats$Squad == "Barcelona"|
                                           top_liga_2018_stats$Squad == "Levante"|
                                           top_liga_2018_stats$Squad == "Betis"),]

# Combine all four seasons' data into one data frame
top_liga_stats <- rbind(top_liga_2018_stats, top_liga_2019_stats, top_liga_2020_stats, top_liga_2021_stats)

goals_act <- data.frame(top_liga_stats$Gls_Per[which(top_liga_stats$Team_or_Opponent == "team")])
goals_act$team <- top_liga_stats$Squad[which(top_liga_stats$Team_or_Opponent == "team")]
goals_act$exp_or_act <- "actual"
goals_act$year <- top_liga_stats$Season_End_Year[which(top_liga_stats$Team_or_Opponent == "team")]
colnames(goals_act)[1] <- "stats"
goals_exp <- data.frame(top_liga_stats$xG_Per[which(top_liga_stats$Team_or_Opponent == "team")])
goals_exp$team <- top_liga_stats$Squad[which(top_liga_stats$Team_or_Opponent == "team")]
goals_exp$exp_or_act <- "expected"
goals_exp$year <- top_liga_stats$Season_End_Year[which(top_liga_stats$Team_or_Opponent == "team")]
colnames(goals_exp)[1] <- "stats"
goals <- rbind(goals_act, goals_exp)

# Plot density ridges
ggplot(data = goals) +
  geom_density_ridges(aes(x = stats, y = team, fill = exp_or_act, color = exp_or_act),
                      alpha = 0.5, scale = 1) +
  scale_x_continuous(limits = c(0.75,2.75)) +
  scale_y_discrete(expand = expand_scale(add = c(0.2, 1))) +
  ggtitle("Expected vs. Actual Goals Per Game") +
  xlab("Goals Per Game") +
  ylab("Team") +
  scale_fill_cyclical(name = "Actual or Expected Goals",
                      labels = c("Actual","Expected"),
                      guide = "legend",
                      values = c("#FF0000A0", "#A0A0A0A0")) +
  scale_color_cyclical(name = "Actual or Expected Goals",
                       labels = c("Actual","Expected"),
                       guide = "legend",
                       values = c("#FF0000A0", "#A0A0A0A0"))

```

Let us break down exactly what this visual is showing us. We are looking at the density of expected and actual goals per game for the top five teams in LaLiga, over the last four seasons (with the last season ending in 2021). We can see that Barcelona is typically scoring more goals than what is expected of them, as the density of actual goals is condensed around higher goal numbers than the density of expected goals. Villarreal, however, is performing just as well as what is expected of them based on expected and actual goals scored.

\newpage

## Volleyball

To begin, let's go over some basic volleyball statistics. The following definitions come from [www.rookieroad.com](www.rookieroad.com)

-   A **Service Ace (SA)** occurs when a player's serve touches the ground on the other team's side without being touched by a player on that side.
-   A **Kill (K)** occurs when a player gets the ball over the net without it being returned by the opponent.
-   An **Assist (AST)** is a pass made directly before a player makes a kill.
-   **Hitting Percentage (PCT)** is the number of attempted kills (minus errors) divided by the total number of kill attempts. This helps determine how well a player or team is succeeding at their kill attempts.

For Volleyball EDA, we will be using CSU Women's Volleyball data from the last five seasons.

```{r include=FALSE}
# Load CSU Women's Volleyball Data
csu_vb <- read_csv("data/csu_volleyball.csv")
colnames(csu_vb)[3] <- "W_L"

```

Let's look at a scatter plot of hitting percentage and the number of digs. While no conclusions can be drawn from such a plot, it can give us some insight into relationships worthy of further analysis. Before creating the plot using the code below, think about what you might expect the outcome to be.

### Scatter Plot

```{r}
# Digs, Hitting Percentage, Win/Lose
dig_pct_viz <- ggplot(data = csu_vb, aes(x = DIG, y = PCT, color = W_L)) +
  geom_point()
dig_pct_viz

```

Let's change the axis titles, legend title, and add a main title.

```{r}
dig_pct_viz +
  labs(title = "Wins and Losses by Number of Digs and Hitting Percentage",
       x = "Number of Digs (DIG)", y = "Hitting Percentage (PCT)",
       color = "Win or Loss")
```

What can we learn from this visual? Well, we can see that there is a weak linear relationship between the number of digs and hitting percentage. To an extent, hitting percentage decreases as the number of digs increases. Why is this the case? Maybe if a team has a really high hitting percentage, this means that the opposing team does not have as many opportunities to attack the other team offensively, reducing the number of opportunities for digs. It also seems that while wins and losses are somewhat evenly spread across the number of digs, there is a more clear cutoff for hitting percentage. It seems that the majority of wins are associated with a hitting percentage of at least 0.2, while the majority of losses are associated with a hitting percentage of less than 0.3.

### Box Plot

Now let's take a closer look at the distribution of hitting percentage and digs for wins and losses. To do this, we will create box plots for each statistic.

```{r}
pct_viz <- ggplot(data = csu_vb, aes(x = PCT, y = W_L)) +
  geom_boxplot()
pct_viz

dig_viz <- ggplot(data = csu_vb, aes(x = DIG, y = W_L)) +
  geom_boxplot()
dig_viz

```

Let's modify these plots to make them more complete and visually appealing.

```{r}
pct_viz +
  labs(title = "Hitting Percentage for Wins and Losses",
       x = "Hitting Percentage (PCT)",
       y = "Win or Loss") +
  geom_boxplot(fill = "slateblue", alpha = 0.2)

dig_viz +
  labs(title = "Number of Digs for Wins and Losses",
       x = "Number of Digs (DIG)",
       y = "Win or Loss") +
  geom_boxplot(fill = "slateblue", alpha = 0.2)

```

Box plots allow us to isolate each statistic (number of kills and hitting percentage) so we can more clearly determine the center and spread of each between wins and losses.

\newpage

## Hockey

For this example, we'll use a set of NHL data from moneypuck.com. First, let's load the data into `R` and open the data frame.

```{r hockey_ggplot1, message=F, warning=F}
nhl_2022_data <- read_csv("https://moneypuck.com/moneypuck/playerData/seasonSummary/2021/regular/teams.csv")

head(nhl_2022_data)
```

We can create nice looking tables using the ``kableExtra'' package. Let's look at the first eight rows and a samll selection of columns of the data frame and format the table output using a kable table.

```{r hockey_ggplot1a}
library("kableExtra")

nhl_2022_data[1:8, c(3,6:9)] %>% kbl() %>% kable_styling()
```

This dataset includes a *lot* of covariates. It also splits these data by different game situations: even-strength (5 on 5), power play (5 on 4), etc. Let's subset the data to include all game situations.

Use the `nrow` command to check the number of columns in the new data frame. Check: Is it the same as the number of teams in the league for the 2021-2022 season?

```{r hockey_ggplot2}
nhl_data_all <- filter(nhl_2022_data, situation == "all")

nrow(nhl_data_all)
```

The dataset includes an Expected Goals statistic for each team in the `xGoalsFor` column. Let's plot this quantity against the team's actual number of goals scored; this is given by the `goalsFor` column.

(Remember to always have a good title and axis labels!)

```{r hockey_ggplot3}
ggplot(data=nhl_data_all, aes(x=xGoalsFor, y=goalsFor)) + labs(x="Expected Goals Scored", y="Actual Goals Scored", title="NHL Teams: Expected vs. Actual Goals, 2021-22") + geom_point()
```

As expected, there is a general positive correlation between expected and actual goals ($r \approx 0.8$). However, there is some variability - for example, the Kings only scored 7 more actual goals than the Ducks, despite having 56.6 more expected goals.

Let's add a line to the graph using the `geom_abline` function corresponding to the line $y=x$, the line on which data points would fall if expected goals were equal to actual goals. We can also customize the line's color and type.

```{r hockey_ggplot4}
ggplot(data=nhl_data_all, aes(x=xGoalsFor, y=goalsFor)) + labs(x="Expected Goals Scored", y="Actual Goals Scored",title="NHL Teams: Expected vs. Actual Goals, 2021-22") + geom_point() + geom_abline(intercept=0, slope=1, color="red", linetype="dashed")
```

*Note: A slope of 0 and an intercept of 1 are actually the default parameters for the function.*

Q: What does it mean for a team's data point to fall below this line? Above it?

A: If the data point is below the line, it means the expected goals were greater than the actual goals; if the data point is above the line, it means the actual goals were greater than the expected goals. 

Q: Do you think that a team's expected goals would be more likely to be closer to its actual goals for a ten-game stretch, an entire season, or five consecutive seasons? Why?

<!-- Question could be reworded/clarified to mean "closer" in a relative (ratio) sense, rather than an absolute sense. -->

A: We would expect that as sample size increases, the result would become closer to expectation. So, actual goals would be most likely closer to expected goals over a span of five seasons.

<!--- This is basically conceptualizing the LLN, but that would rely on this calculation of expected goals being an unbiased estimator of actual goals. -->

