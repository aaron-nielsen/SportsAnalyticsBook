---
output:
  html_document: default
  pdf_document: default
---
# Levi's stuff

```{r, include=FALSE}
library("tidyverse")
```


## Rules of Hockey

[Link to YouTube video describing hockey rules](https://www.youtube.com/watch?v=nv2FUnHceqU)

## Basic Hockey Statistics

* **Goals (G)**: If a team scores, the skater on the scoring team who last touched the puck is credited with a goal.

* **Assists (A)**: The players (up to two) on the scoring team who last touch the puck before the goalscorer are credited with assists, unless the opposing team has possession of the puck in between.

* **Points (PTS)**: Goals plus assists.
  * Not to be confused with team points awarded in the regular season standings by the many hockey leagues, including the NHL (two points for a win, one point for an overtime/shootout loss, zero points for a regulation loss).
  
* **Shots On Goal (SOG)**: Shot attempts in which the puck has been shot directly on goal. Shot attempts which are blocked or miss the goal are not considered SOGs. A team's shots on goal should equal the opposing goaltender's saves plus the team's goals scored.

* **Goals Against Average (GAA)**: Of a goaltender, the number of goals allowed by that goaltender adjusted to a per-60 minute rate.

* **Penalty Minutes (PIM)**: The amount of penalty time an individual player is assigned for their infractions. PIM may be different than the amount of time the player actually spends in the penalty box.

*Reference: https://www.milehighhockey.com/pages/stats*


## Advanced Hockey Statistics

* **CORSI**: CORSI only applies to 5 on 5 ("even-strength") situations. It is calculated as the difference between shot attempts on offense (shots on goal + blocked shots + missed shots) minus shot attempts allowed on defense. CORSI can also be expressed as a percentage, with percentages over 50% indicating that the player is on ice for more offensive shots than defensive shots.

* **Expected Goals (xG)**: Expected Goals statistics give each shot an estimated probability of scoring a goal based on factors such as shot location and game situation. xG cannot be less than 0 or greater than 1 for any particular shot, and different platforms may have different methods of calculating expected goals.

* **Fenwick/Unblocked Shot Attempts (USAT)**: Similar to CORSI, but omits blocked shots from the calculation. This statistic is used in many Expected Goals calculations.

Because the flow of a hockey game is usually quite different in situations other than the normal 5 on 5, such as a power play (5 on 4) or concurrent penalties (4 on 4), many hockey databases separate data by the type of game situation. We will see this below with a dataset from [MoneyPuck](www.moneypuck.com), but it is also present on [Natural Stat Trick](https://www.naturalstattrick.com/), [QuantHockey](www.quanthockey.com), and [hockey-reference](www.hockey-reference.com).

*References: https://www.nhl.com/lightning/news/hockey-analytics-101-understanding-advanced-stats-and-how-theyre-measured/c-735819, https://theathletic.com/121980/2017/10/09/an-advanced-stat-primer-understanding-basic-hockey-metrics/*


## Hockey - Expected and Actual Goals

For this example, we'll use a set of NHL data from moneypuck.com. First, let's load the data into `R` and open the data frame.

```{r hockey ggplot 1}
nhl_2022_data <- read.csv("https://moneypuck.com/moneypuck/playerData/seasonSummary/2021/regular/teams.csv")

View(nhl_2022_data)
```

This dataset includes a *lot* of covariates. It also splits these data by different game situations: even-strength (5 on 5), power play (5 on 4), etc. Let's subset the data to include all game situations.

Use the `nrow` command to examine the number of columns in the new data frame. Check: Is it the same as the number of teams in the league for the 2021-2022 season?

```{r hockey ggplot 2}
nhl_data_all <- filter(nhl_2022_data, situation == "all")
View(nhl_data_all)

nrow(nhl_data_all)
```

The dataset includes an Expected Goals statistic for each team in the `xGoalsFor` column. Let's plot this quantity against the team's actual number of goals scored; this is given by the `goalsFor` column.

(Remember to always have a good title and axis labels!)

```{r hockey ggplot 3}
ggplot(data=nhl_data_all, aes(x=xGoalsFor, y=goalsFor)) + labs(x="Expected Goals Scored", y="Actual Goals Scored", title="NHL Teams: Expected vs. Actual Goals, 2021-22") + geom_point()
```

As expected, there is a general positive correlation between expected and actual goals ($r \approx 0.8$). However, there is some variability - for example, the Kings only scored 7 more actual goals than the Ducks, despite having 56.6 more expected goals.

Let's add a line to the graph using the `geom_abline` function corresponding to the line $y=x$, the line on which data points would fall if expected goals were equal to actual goals. We can also customize the line's color and type.

```{r hockey ggplot 4}
ggplot(data=nhl_data_all, aes(x=xGoalsFor, y=goalsFor)) + labs(x="Expected Goals Scored", y="Actual Goals Scored",title="NHL Teams: Expected vs. Actual Goals, 2021-22") + geom_point() + geom_abline(intercept=0, slope=1, color="red", linetype="dashed")
```

*Note: A slope of 0 and an intercept of 1 are actually the default parameters for the `geom_abline` function.*

Q: What does it mean for a team's data point to fall below this line? Above it?

A: If the data point is below the line, it means the expected goals were greater than the actual goals; if the data point is above the line, it means the actual goals were greater than the expected goals. 

Q: Do you think that a team's expected goals would be more likely to be closer to its actual goals for a ten-game stretch, an entire season, or five consecutive seasons? Why?

<!-- Question could be reworded/clarified to mean "closer" in a relative (ratio) sense, rather than an absolute sense. -->

A: We would expect that as sample size increases, the result would become closer to expectation. So, actual goals would be most likely closer to expected goals over a span of five seasons.

<!--- This is basically conceptualizing the LLN, but that would rely on this calculation of expected goals being an unbiased estimator of actual goals. -->

## Hockey - Goalie Data

For this next example, let's use goalie data from the 2021-2022 season from [Natural Stat Trick](https://www.naturalstattrick.com/). 

```{r goalie data 1}
goalie_data <- read.csv("C:/Users/Fam/Downloads/GoalieTotals_NaturalStatTrick.csv")
View(goalie_data)
```

The dataset includes 119 goalies, but many of them didn't play very much. We can subset the data to include only goaltenders that faced at least 500 shots.

Which player among qualified goalies had the best goals against average? On which team did he play, and what was his GAA?

Which goalie had the most playing time? What was his team, and how much time did he spend on the ice?

```{r goalie data 2}
filtered_goalie_data <- filter(goalie_data, Shots.Against >= 500)

filtered_goalie_data %>% filter(GAA == min(GAA)) %>% select(Player, Team, GAA)
filtered_goalie_data %>% filter(TOI == max(TOI)) %>% select(Player, Team, TOI)
``` 

The following plot compares save percentage to the number of shots on goal faced for the qualified goalies. The dashed horizontal line is placed at the average shots on goal faced among qualified players, and the dashed vertical line is placed at the average save percentage among qualified players.

```{r goalie data 3, echo=FALSE}
ggplot(data=filtered_goalie_data, aes(x=SV., y=Shots.Against)) + labs(x="Save Percentage", y="Shots On Goal Faced",title="NHL Goalies: Save Percentage vs. Volume of Shots, 2021-22") + geom_point() + geom_hline(yintercept=mean(filtered_goalie_data$Shots.Against), color="red", linetype="dashed") + geom_vline(xintercept=mean(filtered_goalie_data$SV.), color="red", linetype="dashed")
```

Q: Which quadrant of the graph represents goalies that faced a higher than average number of shots, but had a below-average save percentage?

A: The second (upper left) quadrant.

Q: Which quadrant represents goalies that had a high save percentage and faced a high volume of shots?

A: The first (upper right) quadrant.

## Hockey - Correlation Plots

When analyzing sports data, there may be many circumstances where statisticians consider which of several variables are most highly correlated to an outcome variable of interest. In this case, it can be useful to use a correlation plot (also known as a correlation matrix or correlogram). Tidyverse and related packages provide many options for creating correlation plots.

Suppose a statistician has recently learned about some advanced hockey statistics and is interested in researching which stat has the highest correlation with goals scored. The statistician wants to compare team shots on goal, CORSI, and Fenwick to observe the association with goals scored for NHL teams.

The following plot uses the same 2021-2022 data from Moneypuck.com; it gives the pairwise scatterplots and correlation values for each of the variables, as well as smoothed plots of each individual variable along the diagonals.

```{r hockey ggplot 5}
library("GGally")

goal_stats <- nhl_data_all %>% select(shotsOnGoalFor, corsiPercentage, fenwickPercentage, goalsFor)
ggpairs(goal_stats, title="Correlation plot of goals and relevant predictors, NHL 2021-22")
```

Q: Which of the variables has the strongest correlation with goals scored?

A: CORSI percentage, r = .702.

In the article ["An advanced stat primer: Understanding basic hockey metrics"](https://theathletic.com/121980/2017/10/09/an-advanced-stat-primer-understanding-basic-hockey-metrics/), Charlie O'Connor states, "Generally speaking, Corsi is more predictive of future goal differential than Fenwick... however, Fenwick forms the basis for the most widely-used Expected Goals models." Let's use the same predictors in a correlation plot with Expected Goals percentage. Does Fenwick have the strongest correlation with xGoal percentage?

```{r hockey ggplot 6}
xGoal_stats <- nhl_data_all %>% select(shotsOnGoalFor, corsiPercentage, fenwickPercentage, xGoalsPercentage)
ggpairs(xGoal_stats, title="Correlation plot of expected goals and relevant predictors, NHL 2021-22")
```


## Rules of Basketball

[Link to YouTube video describing basketball rules](https://www.youtube.com/watch?v=wYjp2zoqQrs)

## Basic Basketball Statistics

* **Field Goal (FG)**: A made shot from either 2- or 3-point range. Free throws, worth 1 point, are not considered field goals. Field goal statistics often include attempts, makes, and percentage.

* **Free Throw (FT)**: After certain fouls, the clock stops and a player shoots an uncontested shot from the foul line. These free throws are worth 1 point each; like with field goals, FT statistics often include attempts, makes, and percentage.

* **Assists (AST)**: A player is credited with an assist if they pass the ball to a teammate and the teammate scores a field goal after zero or one dribbles. No more than one assist can be recorded per field goal.

* **Turnover (TO)**: A player or team can be charged with a turnover for an action or violation that ends their offensive possession before being able to attempt a field goal. For a player (especially a guard), TOs can be compared to assists using Assist:Turnover ratio.

* **Rebound (REB)**: The first player to gain control of the ball following a missed field goal is credited with a rebound. If the player is on the same team as the field goal shooter, it is an offensive rebound; otherwise, a defensive rebound.

* **Points per Possession (PPP)**: Divides a team's points by number of possessions to account for a team's pace.

## Advanced Basketball Statistics

* **True Shooting Percentage (TS%)**: Unlike traditional shooting percentage, this statistic considers both field goals and free throws. It also gives more weight to shots that are worth more points. 

* **Win Shares**: Win shares give each player points for actions that contribute to a team's success. Win shares take into account a variety of offensive and defensive statistics, but can be calculated using different methods on different platforms.

* **Value Over Replacement Player (VORP)**: This is basketball's response to baseball's WAR. VORP is a rate statistic that estimates a player's offensive output as compared to an "average" player.

* **Player Efficiency Rating (PER)**: According to its creator John Hollinger, 
"The PER sums up all a player's positive accomplishments, subtracts the negative accomplishments, and returns a per-minute rating of a player's performance." This statistic rewards great offensive performance more than great defensive plays.

*References: https://www.basketball-reference.com/about/per.html, https://www.basketball-reference.com/about/ws.html, https://www.basketball-reference.com/about/glossary.html*


## Basketball - Four Factors

Tibbles are a type of data frame supported by the `tidyverse` package. The following tibble contains data from a Mountain West tournament game played between the CSU and Wyoming women's basketball teams during the 2021-2022 season, which CSU won 51-38. [(Here's the link to the box score on the CSU athletics website.)](https://csurams.com/sports/womens-basketball/stats/2021-22/wyoming/boxscore/16095)

```{r four factors}
library("tibble")

basketball_data <- tibble(team = c("CSU","WYO"), FG = c(14,15), FGA = c(48,60), THREEP = c(5,4), FT = c(10,4), FTA = c(14,4), ORB = c(2,14), DRB = c(31,30), TOV = c(5,12)); basketball_data
```

This tibble contains all the data needed to calculate the *Four Factors*. The Four Factors of a basketball game are statistics formulated by Dean Oliver, former Director of Quantitative Analysis for the Denver Nuggets (among other roles). These statistics are also promoted by sports data platforms like Hudl.com.

The Four Factors each have offensive and defensive versions; for this example, we'll focus on the offensive perspective.

The first is **Effective Field Goal Percentage**, commonly abbreviated eFG%. The formula is as follows:

$eFG\% = \frac{FG\ +\ 0.5(3P)}{FGA}$

Secondly, **Turnover Percentage** (TOV%) is calculated as:

$TOV\% = \frac{TOV}{FGA\ +\ 0.44(FTA)\ +\ TOV}$

Next, **Rebounding Percentage** (ORB%) is computed as:

$ORB\% = \frac{ORB}{ORB\ +\ Opponent\ DRB}$

Finally, the **Free Throw Factor** is found using:

$FT\ factor = \frac{FT}{FGA}$

Note: You do not have to know these formulas for the test. They are just used for this example.

Let's calculate the values of eFG%, TOV%, ORB%, and Free Throw Factor for both CSU and Wyoming and add them as new columns in the tibble using the `add_column` function.

```{r four factors 2}
attach(basketball_data)
eFG <- round((FG + .5 * THREEP)/FGA, 3) * 100
TOVPCT <- round(TOV / (FGA + .44 * FTA + TOV), 3) * 100
ORBPCT <- round(c(ORB[1]/(ORB[1]+DRB[2]), ORB[2]/(ORB[2]+DRB[1])), 3) * 100
FTFACTOR <- round(FT/FGA, 3) * 100

basketball_data %>% add_column(eFG, TOVPCT, ORBPCT, FTFACTOR)
```

While this method does produce Four Factors data, it could be difficult to scale for calculating the same statistics for a sample of several games. In the next section, we will introduce an `R` package that aids in the calculation of Four Factors.

## Basketball - BasketballAnalyzeR Four Factors

The authors of "Basketball Data Science With Applications in R" developed the `BasketballAnalyzeR` package to be used in conjunction with the book. `BasketballAnalyzeR` includes built-in datasets from the 2017-18 NBA season and provides many functions for analyzing and plotting basketball data. One such function is `fourfactors`, which offers a simpler way to perform a four factors analysis.

```{r basketballanalyzer 1, message=FALSE, warning=FALSE}
library("BasketballAnalyzeR")

teams <- c("DEN", "CLE", "GSW") #Nuggets, Cavaliers, Warriors
team_data <- which(Tadd$team %in% teams)
four_factors_teams <- fourfactors(Tbox[team_data, ], Obox[team_data, ])
print(four_factors_teams)
```

This is a much simpler and neater way to calculate Four Factors.

In the 2017-18 season, the Warriors and Cavaliers met in the NBA Finals, while the Nuggets just missed the playoffs. It would be expected that the two Finals teams would have higher values for the Four Factors. While this is mostly true, for which of the Four Factors did the Nuggets have the highest value?

A: Factor 3 (rebounding percentage), both offensive and defensive.

## Basketball - BasketballAnalyzeR Shot Charts

The `BasketballAnalyzeR` package includes shot location data for all players for the 2017-18 NBA season and has a function called `shotchart` that allows for the plotting of shot data.

Let's plot shot location data for Nikola Jokic. First, the coordinates must be transformed so that the point (0,0) is located at the corner of the court; the original coordinates place the origin at the center of the hoop.

```{r basketballanalyzer 2}
PbP <- PbPmanipulation(PbP.BDB)

jokic_data <- subset(PbP, player == "Nikola Jokic")
jokic_data$xx <- jokic_data$original_x/10 #transformation
jokic_data$yy <- jokic_data$original_y/10 - 41.75 #transformation
```

`BasketballAnalyzeR` supports three types of density visualizations within `shotchart`, one being `density-polygons`. Since `shotchart` is a `ggplot` object, a chart title can be added using `ggtitle`.

```{r basketballanalyzer 3}
shotchart(data = jokic_data, x="xx", y="yy", type="density-polygons") + ggtitle("Nikola Jokic Shot Data, 2017-18")
```

It seems most shots attempts from Jokic were in the paint; this is hardly surprising, since he plays the center position. Here's the same chart with `density-hexbin`:

```{r basketballanalyzer 4}
shotchart(data = jokic_data, x="xx", y="yy", type="density-hexbin") + ggtitle("Nikola Jokic Shot Data, 2017-18")
```

The same chart with `density-raster`:

```{r basketballanalyzer 5}
shotchart(data = jokic_data, x="xx", y="yy", type="density-raster") + ggtitle("Nikola Jokic Shot Data, 2017-18")
```

Within the `shotchart` function, setting `scatter=TRUE` overlays the shots on the chart. Point size and transparency can also be customized.

```{r basketballanalyzer 6}
shotchart(data = jokic_data, x="xx", y="yy", type="density-raster", scatter=TRUE) + ggtitle("Nikola Jokic Shot Data, 2017-18")
```

Let's now compare shot charts of Nikola Jokic, Steph Curry, and Lebron James. This group of players includes one member of each team for which we calculated Four Factors.

```{r basketballanalyzer 7}
curry_data <- subset(PbP, player == "Stephen Curry")
curry_data$xx <- curry_data$original_x/10 #transformation
curry_data$yy <- curry_data$original_y/10 - 41.75 #transformation

james_data <- subset(PbP, player == "LeBron James")
james_data$xx <- james_data$original_x/10 #transformation
james_data$yy <- james_data$original_y/10 - 41.75 #transformation

shotchart(data = jokic_data, x="xx", y="yy", type="density-raster") + ggtitle("Nikola Jokic Shot Data, 2017-18")
shotchart(data = curry_data, x="xx", y="yy", type="density-raster") + ggtitle("Steph Curry Shot Data, 2017-18")
shotchart(data = james_data, x="xx", y="yy", type="density-raster") + ggtitle("Lebron James Shot Data, 2017-18")
```

Q: Of the three players (Jokic, Curry, James), which took the highest percentage of their three-point shots from the right side of the court (when facing the basket)?

A: Nikola Jokic shot almost all of his attempts from the right side. Steph Curry took many shots from beyond the arc and tended toward the left side, while James was split between the right side and the center.

Now, let's focus on Steph Curry's shooting. The following chart splits the court into zones based on angle and distance from the basket. The color in each zone represents the average length of the play leading up to that shot among shots taken in that zone.

```{r basketballanalyzer 8}
shotchart(data = curry_data, x="xx", y="yy", z="playlength", type="sectors", num.sect = 7, scatter=TRUE, pt.alpha=.3) + ggtitle("Steph Curry Shot Data, 2017-18")
```

Q: In general, did Steph Curry tend to shoot closer to the basket during plays of a longer duration or a shorter duration?

A: There is not a perfect correlation, but it seems that two-point field goals were attempted more often during longer plays, while shots taken outside the three-point arc were taken during plays of a shorter duration. 

*References: https://rdrr.io/cran/BasketballAnalyzeR/; Basketball Data Science (Zuccolotto and Manisera, 2020)*

<!-- ## Law of Total Probability - Hockey -->

<!-- Over the course of a season, a hockey player scored a goal 30% of the time during a home game, and $P(player\ scores\ |\ away\ game) = .18$. Assume all games are either home or away. -->

<!-- Q: What is the probability the player scored a goal in any game if there were an equal number of home and away games? -->

<!-- A: $P(score) = P(score|home)P(home) + P(score|away)P(away) = .3(.5) + .18(.5) = .24$ -->

<!-- Q: What is the probability the player scored a goal in any game if there were twice as many home games as away games? -->

<!-- A: $P(score) = P(score|home)P(home) + P(score|away)P(away) = .3(\frac{2}{3}) + .18(\frac{1}{3}) = .26$ -->

<!-- Q: What is the probability the player scored a goal in any game if the ratio of home games to away games is 2:3? -->

<!-- A: $P(score) = P(score|home)P(home) + P(score|away)P(away) = .3(\frac{2}{5}) + .18(\frac{3}{5}) = .228$ -->

<!-- ## Law of Total Probability - Baseball -->

<!-- You work in the front office of a professional baseball club and have just learned that a certain prospect hits .200 against left-handed pitchers and .400 against right-handed pitchers (their overall batting average is unknown). The general manager of the team overhears you talking about the .400 statistic of the player and becomes very exited that they have the chance to draft a .400 hitter. What would you say to caution the GM that the player might not be a remarkable hitter? -->

<!-- A: We don't know the proportion of the player's at-bats that came against left-handed pitchers versus right-handed pitchers. If we want to know the player's batting average unconditional on the type of pitcher they are facing, we have to adjust $P(hit\ |\ left-handed\ pitcher)$ by $P(left-handed\ pitcher)$ and $P(hit\ |\ right-handed\ pitcher)$ by $P(right-handed\ pitcher)$ before adding them to determine $P(hit)$. For example, if 90% of the player's at-bats were against left-handed pitchers, then their overall batting average is a pedestrian .220. -->

<!-- *Other possible issues: low sample size of player's at-bats, the fact that pro pitchers will be harder to hit against than non-pros* -->


<!-- ## Sets and Conditional Probability -->

<!-- 100 sports fans in Colorado were polled and it was found that 64 had attended either a Denver Nuggets or Colorado Avalanche game at Ball Arena (formerly Pepsi Center). 34 people had seen only a Nuggets game, while 17 had seen both a Nuggets and an Avalanche game. -->

<!-- Q: How many people saw an Avalanche game but not a Nuggets game? -->

<!-- A: 64 - 34 - 17 = 13 -->

<!-- Q: What is the probability that a randomly selected person in the poll had been to a Nuggets game? -->

<!-- A: (34 + 17) / 100 = .51 -->

<!-- Q: What is the probability that a randomly selected person that had been to a game at Ball Arena had been to a Nuggets game? -->

<!-- A: (34 + 17) / 64 = .797 -->

<!-- Q: What is the probability that a randomly selected person had been to a Nuggets game given they had been to an Avalanche game? -->

<!-- A: 17 / (17 + 13) = .567 -->


<!-- ## Binomial Probability -->

<!-- Two baseball teams are playing a 4-game series. The home team has a .65 probability of winning each game, and the away team a .35 probability. Assume each game is independent. -->

<!-- *I used baseball in this example because it's the sport that most often has 4-game series, but it could easily be replaced by another sport.* -->

<!-- Find the following probabilities. -->

<!-- (a) The road team wins exactly 1 game. -->

<!-- $\binom{4}{1}\ .65^3\ .35^1 = \binom{4}{3}\ .65^3\ .35^1 \approx .384$ -->

<!-- ```{r} -->
<!-- dbinom(1, 4, .35) -->
<!-- dbinom(3, 4, .65) -->
<!-- ``` -->

<!-- (b) The home team wins exactly 2 games. -->

<!-- $\binom{4}{2}\ .65^2\ .35^2 \approx .311$ -->

<!-- ```{r} -->
<!-- dbinom(2, 4, .65) -->
<!-- dbinom(2, 4, .35) -->
<!-- ``` -->

<!-- (c) The road team wins at least 2 games. -->

<!-- $\binom{4}{2}\ .65^2\ .35^2 + \binom{4}{3}\ .65^1\ .35^3 + .35^4 = 1 - [.65^4 + \binom{4}{1}\ .65^3\ .35^1]  \approx .437$ -->

<!-- ```{r} -->
<!-- pbinom(1.9, 4, .35, lower.tail=F) -->
<!-- pbinom(2, 4, .65, lower.tail=T) -->
<!-- ``` -->

<!-- (d) The series ends in a sweep. -->

<!-- $.65^4 + .35^4 \approx .194$ -->

<!-- ```{r} -->
<!-- dbinom(4, 4, .65) + dbinom(4, 4, .35) -->
<!-- .65^4 + .35^4 -->
<!-- ``` -->



<!-- ## Binomial Coefficient Symmetry -->

<!-- Playoff series for a certain sports league are played as a best-of-seven series, with one team hosting four games and the opposing team hosing three. An executive for the league wishes to know the number of ways the home and away games can be assigned. (One such combination is A-A-B-B-A-B-A, the format used by the NBA and NHL for their best-of-seven series.) What is the total number of combinations? -->

<!-- Answer: Since there are a fixed number of games (seven) and a fixed number of games that must be given to the lower-seeded team (four), there are $\binom{7}{4} = \frac{7!}{4!\ \cdot\ (7-4)!} = 35$ ways to create a home-away pattern for the seven-game series. -->

<!-- However, instead of thinking about the number of ways to assign the games to the team that gets four home games, what if we thought about the number of ways to assign games to the team that gets three home games? -->

<!-- That would be $\binom{7}{3}$. We can use the `choose` command in `R` to find this quantity. -->

<!-- ```{r bin} -->
<!-- choose(7,3) -->
<!-- ``` -->

<!-- It turns out that this binomial coefficient is also equal to 35. -->

<!-- Theorem: $\binom{n}{k} = \binom{n}{n-k}$ -->

<!-- $\binom{n}{k} = \frac{n!}{k!\ \cdot\ (n-k)!}$ -->

<!-- $\binom{n}{n-k} = \frac{n!}{(n-k)!\ \cdot\ (n-(n-k))!} = \frac{n!}{(n-k)!\ \cdot\ k!} = \binom{n}{k}$ -->


<!-- ## Binomials and Multinomials -->

<!-- Suppose we are curious about probabilities regarding the results of a soccer team’s next five games. -->

<!-- Wait!!! A soccer game has three possible outcomes (win, lose, draw)! We can’t use the binomial distribution, since it limits us to two possible outcomes! -->

<!-- It depends. If we are interested in the probability that a soccer team wins 2 of their next 5 games, we can use the binomial distribution. We can create the following partition of the sample space of outcomes: $(Win)$ and $(Win^C)$, where the second set includes both losing and drawing. -->

<!-- Then, the formula would be represented as: -->

<!-- $\binom{5}{2}\ P(Win)^2\  P(Win^C)^{(5-2)}$ -->

<!-- If we are interested in the probability of the team winning two of the next five games, drawing two, and losing one, we cannot use the binomial theorem. That involves three outcomes, and would be represented as a multinomial. <!--- assuming regularity conditions such as independence. --> -->

## Multinomial Distribution - Baseball

The following PMF displays the number of possible bases for a hit in baseball against the frequency of that type of hit for Hank Aaron, who is third all-time in Major League baseball hits with 3,771.

```{r multinomial, include=F}
Number_bases <- c(1:4)
Hit_Frequency <- c(2294, 624, 98, 755)
Hit_Proportion <- round(Hit_Frequency / sum(Hit_Frequency), 5)

Hank_Aaron_PMF <- data.frame(Number_bases, Hit_Proportion); Hank_Aaron_PMF
```

| Number of Bases, $x$  | 1 | 2 | 3 | 4 |
|:---------------------:|:-:|:-:|:-:|:-:|
| Probability, $P(X=x)$ | 0.61 | 0.16 | 0.03 | 0.20 |

Q: What is the probability that a randomly selected subset of 5 hits from Hank Aaron includes three singles, one double, and one home run?

<!-- note: assumes sampling with replacement. Without replacement would be a multivariate hypergeometric and would slightly increase the probability.  -->

A: From the Multinomial PMF, this is $P(X_1 = 3, X_2 = 1, X_3 = 0, X_4 = 1) = \frac{5!}{3!\ \cdot 1!\ \cdot 0!\ \cdot 1!}\ (.61)^3\cdot\ (.16)^1\cdot\ (.03)^0\cdot\ (.20)^1 \approx .145$

The probability can also be found in `R` using the `dmultinom` function.

```{r multinomial 2}
dmultinom(x = c(3, 1, 0, 1), prob = c(.61, .16, .03, .20))
```

<!-- ## Geometric (First Success) RVs -->

<!-- Caution: Some references parameterize the Geometric distribution based on the number of failures before the first success, rather than the trial on which the first success occurs. This changes the PMF, mean, and variance, so be careful. -->

<!-- ```{r} -->
<!-- set.seed(2022) -->
<!-- geometric <- rgeom(100, 1/3) -->
<!-- head(geometric, 20) -->
<!-- ``` -->

<!-- Some of the values were 0, which could not happen if `R` was considering the number of the trial on which the first success occurred. You can add 1 to the values given by `R` to arrive at the First Success distribution. -->

<!-- ```{r} -->
<!-- first_success <- geometric + 1 -->
<!-- head(first_success, 20) -->
<!-- mean(first_success) -->
<!-- ``` -->
<!-- The mean of this sample of variables is 3.03, which is close to the expected mean of $\frac{1}{p} = 3$. -->

<!-- ## Geometric Distribution - Hockey -->

<!-- Suppose the number of shots needed by a hockey team in order to score their first goal, $X$, is modeled by a Geometric($\frac{1}{10}$) random variable. -->

<!-- Q: What is the probability that it takes more than 3 shots to score the first goal? -->

<!-- A: $P(X > 3) = P(X = 4) + P(X = 5) + P(X = 6) +\ ...$ -->

<!-- This is an infinite series, so let's use the Complement Rule. -->

<!-- $P(X > 3) = 1 - P(X \leq 3) = 1 - \sum_{i=1}^{3}P(X = i) = 1 - [\frac{1}{10} + (\frac{9}{10})^1(\frac{1}{10}) + (\frac{9}{10})^2(\frac{1}{10})] = .729$ -->

<!-- Q: Why might the assumptions for the Geometric distribution make it an imperfect model for this situation? -->

<!-- A: Geometric random variables assume a constant probability for each trial (in this case, shots on goal). In hockey, the probability of a shot hitting the back of the net changes based on its location, velocity, positioning of defensive players, whether the team is on the power play, etc. -->

<!-- ## Poisson Distribution - Soccer -->

<!-- During the 2021 Major League Soccer season, the Colorado Rapids scored 51 goals in 34 games on their way to a first-place finish in the Western Conference regular season standings. -->

<!-- The team scored $\frac{51}{34} = 1.5$ goals per game. Let's model the distribution of Rapids goals using a Poisson(1.5) random variable that we'll call Y. -->

<!-- Q: Which is more likely: Y taking on the value 0 or Y taking on the value 2? -->

<!-- We can plot the PMF of Y to check visually. -->

<!-- ```{r soccer poisson} -->
<!-- ggplot(transform(data.frame(x=c(0:8)), y=dpois(x, lambda = 1.5)), aes(x, y)) + geom_bar(stat="identity") + labs(x="Value", y="Frequency", title="Probability mass function of Poisson(1.5) random variable") -->
<!-- ``` -->

<!-- A: From the plot, $P(Y = 2) > P(Y = 0)$. -->

<!-- Q: What is the exact probability that this Poisson(1.5) random variable takes on the value 2? -->

<!-- A: We can find this quantity using the `dpois` command. -->

<!-- ```{r soccer poisson 2} -->
<!-- dpois(x=2, lambda=1.5) -->
<!-- ``` -->
<!-- The same quantity can be obtained by plugging the numbers into the Poisson PMF. -->

<!-- $\frac{1.5^2 e^{-1.5}}{2!} = 0.251$ -->

<!-- Q: Let's switch it around. What is the probability that a Poisson(2) random variable takes on the value 1.5? -->

<!-- A: 0. Poisson random variables cannot take on values other than nonnegative integers. Remember, Poisson random variables are often used for count data. -->


<!-- Let's check whether using a Poisson distribution was appropriate by comparing it to the actual 2021 Colorado Rapids match results. -->

<!-- <!-- https://www.espn.com/soccer/team/results/_/id/184/season/2021 --> -->

<!-- ```{r soccer poisson 3} -->
<!-- library("kableExtra") -->

<!-- goals <- c(0:4, "5 or more") -->
<!-- actual_frequency <- c(6, 14, 7, 6, 0, 1) -->
<!-- actual_proportion <- actual_frequency / sum(actual_frequency) -->
<!-- expected_proportion <- c(dpois(0:4, lambda=1.5), ppois(4, lambda=1.5, lower.tail=FALSE)) -->
<!-- expected_frequency <- round(expected_proportion * 34, 1) -->

<!-- rapids.data <- data.frame(goals, actual_frequency, actual_proportion, expected_frequency, expected_proportion) -->

<!-- rapids.data %>% -->
<!-- kbl() %>% -->
<!-- kable_styling() -->
<!-- ``` -->

<!-- *answers may vary for following questions* -->

<!-- Q: What differences do you notice between the actual results and the expected values based on the Poisson random variable? -->

<!-- A: There were fewer games in which the Rapids scored 4 or more goals than the model would indicate, yet the Rapids were shut out less often than the model would indicate. -->

<!-- Q: Even if the true population distribution of 2021 Rapids goals was truly a Poisson(1.5) random variable, why might the actual distribution of their goals differ from the probability mass function? -->

<!-- A: 34 is a relatively small sample size; random variables may not coincide with their expected values for finite sample sizes. -->

<!-- Q: What are the advantages of using the Poisson distribution to model Major League soccer goals? What are the disadvantages? -->

<!-- A: Poisson random variables can take on the natural numbers (including zero), which aligns with the number of goals that can be scored in a match. One disadvantage is that it is possible for a Poisson to take on values that are not realistic for the situation, such as double-digit integers or higher. Only one game in MLS history has had a team score more than seven goals in a game. However, when $\lambda$ is small (such as 1.5), these extreme values are relatively unlikely. -->



<!-- ## Multiple Probability Distributions - Basketball -->

<!-- Suppose the number of points scored by a basketball player follows a Poisson(12) random variable, the number of rebounds by a Poisson(7) distribution, and assists by a Discrete Uniform(2, 11), independently of each other. -->

<!-- Q: What is the probability that this player records a points, rebounds, assists triple-double in a game? -->

<!-- A: $P(Triple\ Double) = P(Points \geq 10\ \cap\ Rebounds \geq 10\ \cap\ Assists \geq 10)$ -->

<!-- ```{r basketball probability 1} -->
<!-- ppois(9, lambda = 12, lower.tail=F) -->
<!-- ``` -->

<!-- $P(Points \geq 10) = P(Poisson(12) \geq 10) \approx .758$ -->

<!-- ```{r basketball probability 2} -->
<!-- ppois(9, lambda = 7, lower.tail=F) -->
<!-- ``` -->

<!-- $P(Rebounds \geq 10) = P(Poisson(7) \geq 10) \approx .170$ -->

<!-- $P(Assists \geq 10) = P(Discrete\ Uniform(2, 11) \geq 10) = .2$ -->

<!-- Since the events are independent, we can multiply their probabilities. The probability of the player scoring the triple-double is $(.758)(.170)(.2) = .0257$. -->

<!-- Q: Your friend offers you 4 to 1 that the player will not record a triple-double in their next 10 games. With the knowledge that the athlete's performance in a game is unaffected by performances in previous games, would you take the bet? -->

<!-- A: $P(no\ triple\ double) = 1 - .0257 = .9743$, so $P(no\ triple\ double\ in\ next\ 10\ games) = (.9743)^{10} = .771$ -->

<!-- The odds of no triple-double are $\frac{.771}{1-.771} = 3.37$, so the bet of no triple-double at 4 to 1 odds is favorable. -->

<!-- ## Basketball Scenario -->

<!-- You are the coach of a basketball team that is down two points with one second remaining in the fourth quarter. During a timeout, you are considering the best play to call for your team. The first option is a three-point shot attempt, which you estimate has a 30% chance of succeeding. The second option is a two-point shot attempt, which has a 50% chance of making the field goal, a 30% chance of missing it and ending the game, and a 20% chance the shooter will miss but be fouled, in which case the shooter's free throw success will follow a $Bin(2, .8)$ random variable. Finally, you estimate that your team's probability of winning the game in overtime is .45. -->

<!-- Assume the above situations are exhaustive (i.e., the other team will not get another possession, no fouls will be called before the ball is put in play, lightning will not hit the arena and postpone the game, etc.). Which of the two plays should you call to maximize the win probability for your team? -->

<!-- A: The probability of winning the game with the three-point shot attempt is .3. If the two-point shot attempt is called for, there is a .5 probability of making the field goal and a (.2)(.8)(.8) = .128 probability that the foul is called and both free throws are made. Thus, the total probability of scoring two points and sending the game to overtime is .628. Then, the probability of winning the game in OT after tying it in regulation is (.628)(.45) = .2828. This is less than .3, so shooting the three-pointer is the option that maximizes the win probability, given these situational probabilities. -->

<!-- Q: What is the minimum estimated overtime win probability to make calling for the two-point play the better option? -->

<!-- A: $P(score\ 2\ points\ in\ regulation) \cdot P(win\ in\ OT) > P(win\ in\ regulation)$\ -->
<!-- $.628 \cdot P(win\ in\ OT) > .3$\ -->
<!-- $P(win\ in\ OT) > .478$ -->

<!-- ## Expectation - Baseball -->

<!-- The expectation of a discrete random variable is a weighted average. The "weights" are the probabilities of the possible values of the variable. -->

<!-- Consider the following table, which shows the number of career hits by type for the all-time Major League Baseball leader in total bases, Hank Aaron. -->

<!-- <!-- https://www.baseball-reference.com/players/a/aaronha01.shtml --> -->

<!-- ```{r expectation baseball, echo=F} -->
<!-- Hit_type <- c("Single", "Double", "Triple", "Home Run") -->
<!-- Number_bases <- c(1:4) -->
<!-- Hit_Frequency <- c(2294, 624, 98, 755) -->
<!-- Hit_Proportion <- round(Hit_Frequency / sum(Hit_Frequency), 8) -->

<!-- Hank_Aaron_Hits <- data.frame(Hit_type, Number_bases, Hit_Frequency, Hit_Proportion) -->

<!-- Hank_Aaron_Hits %>% -->
<!-- kbl() %>% -->
<!-- kable_styling() -->
<!-- ``` -->

<!-- The expected number of bases for a Hank Aaron hit is the sum of the number of bases attained for each hit multiplied by the relative frequency of the occurrence of that type of hit. -->

<!-- $1 \cdot \frac{2294}{3771} + 2 \cdot \frac{624}{3771} + 3 \cdot \frac{98}{3771} + 4 \cdot \frac{755}{3771} = 1.18181$ -->

<!-- This is the same process that is occurring whenever we calculate the expectation of any discrete random variable. Recall the formula for expectation is $E[X] = \sum_{x \in \Omega}\ x \cdot p(x)$. Each value in the sample space is "adjusted" by the probability of that value, then the sum of all values in $\Omega$ is taken to arrive at the weighted average, or expected value, of the random variable. -->


<!-- ## A few reminders/tips for simulation, and a basic example -->

<!-- The number of regulation goals scored in a game by Hockey Team A, $X$, is a Poisson(4) random variable, and the same for Hockey Team B, $Y$, is a Poisson(3.2) random variable. -->

<!-- A statistician is interested in the probability that Team A defeats Team B in regulation. This is $P(X > Y)$, which is difficult to calculate manually. However, using simulation, we can straightforwardly obtain an accurate estimation of this quantity. -->

<!-- There are many built-in functions in `R` that allow users to generate realizations from common probability distributions (`rnorm`, `rbinom`, `rexp`, etc.) Let's use the `rpois` function to simulate the appropriate variables, remembering to set a seed so that our results are easily replicable. -->

<!-- ```{r hockey poisson simulation 1} -->
<!-- set.seed(2022) -->

<!-- nReps <- 1e4 -->

<!-- team_A_goals <- rpois(n = nReps, lambda = 4) -->
<!-- team_B_goals <- rpois(n = nReps, lambda = 3.2) -->
<!-- ``` -->

<!-- Now, to find $P(X > Y)$, we can use the following line of code: -->

<!-- ```{r hockey poisson simulation 2} -->
<!-- mean(team_A_goals > team_B_goals) -->
<!-- ``` -->

<!-- Why does this work? First, operations to vectors are executed elementwise, meaning that `R` compares `team_A_goals[1]` to `team_B_goals[1]`, then `team_A_goals[2]` to `team_B_goals[2]`, and so on. Second, logical operators are stored as zeroes (when the condition is false) and ones (when the condition is true). The mean of a vector of zeroes and ones is the proportion of ones, which is the frequency of the logical statement being true. In our simulation, it was 0.5415. The true value is 0.5427, meaning that the simulation was quite accurate. -->

<!-- These tips will help you be more efficient when performing simulation tasks in `R`. -->

<!-- ```{r hockey poisson simulation 3, include=FALSE} -->
<!-- #computation for finding the theoretical value of P(X>Y) to within at least 7 decimal points. There's probably an easier way to do this. -->

<!-- v <- rep(NA, 50) -->

<!-- for (j in 1:50) { -->
<!--   v[j] <- ppois(j-1, lambda = 4, lower.tail=F) * dpois(j-1, lambda = 3.2) -->
<!-- } -->
<!-- sum(v) -->
<!-- ``` -->

<!-- ## Streak Simulation - Basketball -->

<!-- Suppose an NBA team is in the middle of a rebuild and has a 25% probability of winning each of its games in the following 82-game season. -->

<!-- Q: What is the probability that the team will go on at least one winning streak of four or more games over the course of the 82-game season? -->

<!-- A: We can simulate a season for the team, find the longest winning streak in that season, and store it in a vector. After repeating that process 10,000 times, we can then find the proportion of the values in that vector that are greater than or equal to 4. -->

<!-- ```{r basketball streaks simulation} -->
<!-- set.seed(2022) -->

<!-- nReps <- 1e4 -->
<!-- longest_streak <- rep(NA, nReps) -->

<!-- for (i in 1:nReps) { -->
<!--   game_results <- rbinom(size = 1, n = 82, prob = .25) # 1=win, 0=loss -->
<!--   streaks <- rle(game_results) -->
<!--   longest_streak[i] <- max(streaks$lengths[streaks$values==1]) -->
<!-- } -->

<!-- table(longest_streak) -->
<!-- mean(longest_streak >= 4) -->
<!-- ``` -->

<!-- <!-- https://stackoverflow.com/questions/28731582/maximum-consecutive-repeats-in-a-vector-in-r --> -->

<!-- The team had a 4+ game winning streak in about 20% of the simulations.  -->

