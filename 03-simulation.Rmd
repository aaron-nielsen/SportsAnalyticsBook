---
output:
  html_document: default
  pdf_document: default
---
# Monte Carlo Simulation 

```{r, echo=F, message=F,warning=F}
library(tidyverse)
library(kableExtra)

# kable table global setup
kt <- function(data) {
  knitr::kable(data, digits=3, align=c('l','c','c','c','c','c','c','c','c')) %>% kable_styling(bootstrap_options='striped', latex_options='HOLD_position', full_width = F, position = "center")
}
```

## Basics

Monte Carlo Simulation is a collection of computer-driven, computational algorithms that use repeated random sampling to calculate estimates. The basic steps for such a simulation are as follows:

- Initialize vectors and variables 

- Run a simulation and calculate the estimate of interest

- Save the estimate

- Run the simulation "n" times

- Analyze the estimates from the "n" simulations \

One function that will be particularly useful for simulation is `set.seed()`.

`set.seed()` allows us to replicate any simulation by giving the initial seed for the simulation. The actual number that is "seeded" is not particularly important though if you want to replicate the same simulations, you will want to re-use this number.

\newpage

:::{.example}
Simulate 10 overtime coin tosses with and without using `set.seed()` and compare the results
:::

```{r}
# Sample 1
sample(c("H","T"),size=10,prob=c(0.5,0.5),replace=T)

# Sample 2
sample(c("H","T"),size=10,prob=c(0.5,0.5),replace=T)

# Sample 3
set.seed(2020)
sample(c("H","T"),size=10,prob=c(0.5,0.5),replace=T)

# Sample 4
set.seed(2020)
sample(c("H","T"),size=10,prob=c(0.5,0.5),replace=T)
```

Simulation can be very helpful when you want to estimate quantities that are not easily solved using analytical methods like formulas.

\newpage

:::{.example}
Shaquille O'Neal has a career free throw percentage of 52.7%. Suppose that Shaq takes 10 free throw shots. What is the probability that he makes all 10 shots?
:::

In this case, we can calculate the exact probability of interest using binomial random variable.

```{r}
dbinom(x=10,size=10,prob=0.527)
```

In more complicated simulations, there may not be an easy formula to use to calculate the value of interest. In these situations, simulation can be very helpful in estimating quantities.

```{r, include=F}
library(tidyverse)
```

```{r}
set.seed(2020)

# Number of Simulations
n.sims <- 10000

# Initialize FT variable with 10000 zeros
FT <- rep(0,n.sims)

for(i in 1:n.sims){
  # Simulate 10 free throws
  temp <- sample(x=c(0,1), size = 10, replace = T, prob = c(0.473,0.527) )
  
  # Count the number of free throws made and store them in FT
  FT[i] <- sum(temp)
}

FT %>% 
  as.data.frame() %>% 
  ggplot(aes(x=FT)) + 
  geom_bar() +
  ggtitle("Number of free throws made out of 10") + scale_x_continuous(breaks = seq(0, 10, by = 2))

prob10 <- sum(FT == 10)/n.sims; prob10
```

The estimated probability that Shaq goes 10-for-10 in free throw attempts based on his career average is 0.0023.

If we run the simulation again with a different seed, we will get another estimate (0.0019).

```{r}
set.seed(1)

# Number of Simulations
n.sims <- 10000

# Initialize FT variable with 10000 zeros
FT <- rep(0,n.sims)

for(i in 1:n.sims){
  # Simulate 10 free throws
  temp <- sample(x=c(0,1), size = 10, replace = T, prob = c(0.473,0.527) )
  
  # Count the number of free throws made and store them in FT
  FT[i] <- sum(temp)
}

prob10 <- sum(FT == 10)/n.sims; prob10
```

As we increase the number of simulations, the estimate will become more accurate.

```{r}
set.seed(1)

# Number of Simulations
n.sims <- 100000

# Initialize FT variable with 10000 zeros
FT <- rep(0,n.sims)

for(i in 1:n.sims){
  # Simulate 10 free throws
  temp <- sample(x=c(0,1), size = 10, replace = T, prob = c(0.473,0.527) )
  
  # Count the number of free throws made and store them in FT
  FT[i] <- sum(temp)
}

prob10 <- sum(FT == 10)/n.sims; prob10
```

One way to simulate data is to make assumptions about the distributions of the underlying data. The random variables given in the last chapter as possible candidates.


## Estimating Probabilities

We can use simulation to estimate probabilities of different events occurring. One way to do this is for each simulation to record a "1" if the event of interest occurs and a "0" if the event of interest does not occur.

:::{.definition}
The ***indicator function***, $I(A)$, is defined such that $I(A)$ is equal to 1 if $A$ occurs and is equal to 0 if $A$ does not occur.
:::

For instance, suppose we roll a die and a "6" is on top. Then we have the following: $I(6)=1, I(5)=0, I(even)=1, I(odd)=0$.

One way to calculate probabilities is to use the following rule: $P(A) = E[I(A)]$. The probability that $A$ occurs is equal to the expected value of the indicator function of $A$.

:::{.example}
During the 2021 WNBA season, Kahleah Copper of the Chicago Sky had a free throw percentage of 81.8%. She played a total of 32 games and the probability mass function for number of free throw attempts per game are given in the table below. Estimate the probability that Copper did not make a free throw in a game. [Note: Copper did not make a free throw in 6 out of the 32 games for a probability of 0.1875.]
:::

```{r, include=F}
# Helpful function for formatting number of digits for each kable table row
# Source: https://stackoverflow.com/questions/30949768/r-vary-by-row-the-rounding-of-digits-produced-by-knitrkable
digitsByRows <- function(df, digits) {
  tmp0 <- data.frame(t(df))
  tmp1 <- mapply(
    function(df0, digits0) {
      formatC(df0, format="f", digits=digits0)
    },
    df0=tmp0, digits0=digits
  )
  tmp1 <- data.frame(t(tmp1))
  names(tmp1) <- names(df)
  return(tmp1)
}
```

```{r,message=F,echo=F}
library(kableExtra)
games <- 32
FTA <- 0:8
nFTA <- c(5,2,8,0,7,2,4,2,2)
pFTA <- nFTA/32
df <- t(data.frame(FTA,nFTA,pFTA))
row.names(df) = c("Free Throw Attempts Per Game, FTA","Number of Occurrences, nFTA","Probability, p(FTA)")
kable(digitsByRows(df,c(0,0,3)),row.names=F) %>% kable_styling(full_width = F)
```

```{r}
set.seed(2020)
n.sims <- 10000
games <- 32
FTprob <- 0.818
FTA <- 0:8
nFTA <- c(5,2,8,0,7,2,4,2,2)
pFTA <- nFTA/32
FT <- rep(0, n.sims)
FT0.ind <- rep(0,n.sims)

# Simulate the number of FTA per game
FTA.sim <- sample(x = FTA,size = n.sims,replace = T,prob = pFTA)

# Simulate 10,000 games and record number of FT made
for(i in 1:n.sims){
  FT[i] <- rbinom(n=1,size = FTA.sim[i],prob = 0.818)
}

# Look at the header of the simulated data
head(FT)

# Create indicator function for 0 FT made
FT0.ind = FT == 0
head(FT0.ind)

# Estimate probability of 0 FT made
sum(FT0.ind)/n.sims
```

\newpage

:::{.example}
The number of regulation goals scored in a game by Hockey Team A, $X$, is a Poisson(4) random variable, and the same for Hockey Team B, $Y$, is a Poisson(3.2) random variable.

A statistician is interested in the probability that Team A defeats Team B in regulation. This is $P(X > Y)$, which is difficult to calculate manually. However, using simulation, we can straightforwardly obtain an accurate estimation of this quantity.
:::

There are many built-in functions in `R` that allow users to generate realizations from common probability distributions (`rnorm`, `rbinom`, `rexp`, etc.) Let's use the `rpois` function to simulate the appropriate variables, remembering to set a seed so that our results are easily replicable.

```{r hockey poisson simulation 1}
set.seed(2022)

nReps <- 1e4

team_A_goals <- rpois(n = nReps, lambda = 4)
team_B_goals <- rpois(n = nReps, lambda = 3.2)
```

Now, to find $P(X > Y)$, we can use the following line of code:

```{r hockey poisson simulation 2}
mean(team_A_goals > team_B_goals)
```

Why does this work? First, operations to vectors are executed elementwise, meaning that `R` compares `team_A_goals[1]` to `team_B_goals[1]`, then `team_A_goals[2]` to `team_B_goals[2]`, and so on. Second, logical operators are stored as zeroes (when the condition is false) and ones (when the condition is true). The mean of a vector of zeroes and ones is the proportion of ones, which is the frequency of the logical statement being true. In our simulation, it was 0.5415. The true value is 0.5427, meaning that the simulation was quite accurate.

These tips will help you be more efficient when performing simulation tasks in `R`.

```{r hockey poisson simulation 3, include=FALSE}
# computation for finding the theoretical value of P(X>Y) to within at least 7 decimal points. There's probably an easier way to do this.

v <- rep(NA, 50)

for (j in 1:50) {
  v[j] <- ppois(j-1, lambda = 4, lower.tail=F) * dpois(j-1, lambda = 3.2)
}
sum(v)
```

## Streak Simulation - Basketball

Suppose an NBA team is in the middle of a rebuild and has a 25% probability of winning each of its games in the following 82-game season.

Q: What is the probability that the team will go on at least one winning streak of four or more games over the course of the 82-game season?

A: We can simulate a season for the team, find the longest winning streak in that season, and store it in a vector. After repeating that process 10,000 times, we can then find the proportion of the values in that vector that are greater than or equal to 4.

```{r basketball streaks simulation}
set.seed(2022)

nReps <- 10000
longest_streak <- rep(NA, nReps)

for (i in 1:nReps) {
  game_results <- rbinom(size = 1, n = 82, prob = .25) # 1=win, 0=loss
  streaks <- rle(game_results)
  longest_streak[i] <- max(streaks$lengths[streaks$values==1])
}

table(longest_streak)
mean(longest_streak >= 4)
```

<!-- https://stackoverflow.com/questions/28731582/maximum-consecutive-repeats-in-a-vector-in-r -->

The team had a 4+ game winning streak in about 20% of the simulations. 

## Hitting Streak Simulation

:::{.example}
In 1941, Joe DiMaggio had a 56-game hitting streak which is an all-time record in MLB. How unlikely was such an outcome? Let's build a simulation to estimate the probability of a hitting streak of at least 56 games using DiMaggio's statistics.

DiMaggio had 193 hits in 622 plate appearances over 139 games. We will simulate DiMaggio's season of 139 games many times to estimate the probability of a 56-game hitting streak. Assume that in each game DiMaggio has a 50\% chance of 4 plate appearance and a 50\% chance of 5 plate appearances. For a plate appearance, DiMaggio had a probability of $193/622 = 0.310$ of getting a hit.
:::

```{r}
set.seed(2022)
n.sims <- 10000
n.games <- 139

longest.streak <- rep(0, n.sims)
sim.games <- rep(0,n.games)

for( i in 1: n.sims){
  for( j in 1:139){
    sim.ab <- sample(x=c(4,5),size=1,replace=T)
    sim.games[j] <- rbinom(n = 1,size = sim.ab,prob = 0.310)
  }
  sim.hits <- ifelse(sim.games > 0,1,0)
  streaks <- rle(sim.hits)
  longest.streak[i] <- max(streaks$lengths[streaks$values==1])
}

table(longest.streak)
longest.streak %>% 
  as.data.frame() %>% 
  ggplot(aes(x=longest.streak)) + 
  geom_histogram(binwidth=2) +
  labs(title = "Longest Hitting Streak for 10,000 Simulated DiMaggio 1941 Seasons") +
  xlab("Max Hitting Streak in a Simulation Season")
mean(longest.streak)
mean(longest.streak>55)
```
This code is slow because we have nested for loops. When at all possible, you would like to avoid using nested for loops.

Running the simulation above with `set.seed(2022)` and `n.sims=10000`, we get $P(Streak \geq 66) = 0$. No hitting streak of 56 games or more in this simulation.

If we run the simulation again with `set.seed(2022)` but increase `n.sims=100000`, we get $P(Streak \geq 66) = \frac{9}{100000} = 9 \cdot 10^{-5}$. In other words, we estimate the probability that DiMaggio gets a hitting streak of at least 56 games in 100000 simulated seasons is about 1-in-10000.

This simulation is slow, so let's try coding it up in a few different ways to show you some options when simulating.

```{r}
# Alternate DiMaggio hitting streak simulation 
set.seed(2022)
n.sims <- 100000
n.games <- 139

longest.streak <- rep(0, n.sims)

# simulate at bats for n.sims * n.games = 139*100000
sim.games <- sample(c(4,5),size=n.sims*n.games,replace=T)
sim.games <- as.matrix(sim.games,nrow=n.sims,ncol=n.games)

# count number of 4 and 5 at bat games
n4 <- sum(sim.games == 4)
n5 <- sum(sim.games == 5)

# simulate number of hits in 4 at bat games
hits4 <- rbinom(n=n4,size=4,prob=0.310)
hits5 <- rbinom(n=n5,size=5,prob=0.310)

# hit games: 1 = got at least one hit, 0 = not hit
hits4i <- ifelse(hits4 > 0,1,0)
hits5i <- ifelse(hits5 > 0,1,0)

sim.hit.games <- matrix(0,ncol=n.games,nrow=n.sims)
sim.hit.games[which(sim.games == 4)] = hits4i
sim.hit.games[which(sim.games == 5)] = hits5i

for( i in 1:n.sims){
  streaks <- rle(sim.hit.games[i,])
  longest.streak[i] <- max(streaks$lengths[streaks$values==1])
}

table(longest.streak)
longest.streak %>% 
  as.data.frame() %>% 
  ggplot(aes(x=longest.streak)) + 
  geom_histogram(binwidth=2) +
  labs(title = "Longest Hitting Streak for 10,000 Simulated DiMaggio 1941 Seasons") +
  xlab("Max Hitting Streak in a Simulation Season")
mean(longest.streak)
mean(longest.streak>55)
```

The code for this alternate simulation is a bit less intuitive but it is much faster.

Running the alternate simulation above with `set.seed(2022)` and `n.sims=100000`, we get $P(Streak \geq 66) = 0.00012$. 

Running the simulation above with `set.seed(2022)` and `n.sims=1000000`, we get $P(Streak \geq 66) = 0.000132$. 

All of these simulations suggest that using DiMaggio's 1941 statistics of having a hitting streak of at least 56 games was about 1-in-8000.

Other authors have used different simulation and mathematical methods for estimating the rarity of Dimaggio's 56 game hitting streak.

Billie et al (2010) used an at-bat rather than plate appearance simulation and estimated the likelihood as 1-in-5000. 

Rothman et al (2010) estimated the likelihood as 1-in-10000.

## Shaq FT simulation

:::{.example}
In 1997-1998 with the Los Angeles Lakers, Shaq attempted an average of 11.35 free throws per game with a standard deviation of 4.04. While with the Lakers, Shaq played in an average of 63.6 games per year with a standard deviation of 10.6. Create a simulation to model the season total number of free throw attempts that Shaq would have while with the Lakers. 

Note: his actual season totals of free throws attempted while with the Lakers were: 479, 681, 498, 824, 972, 712, 725, 676
:::

Let's model the number of games that Shaq played in as a Binomial random variable. There are 82 regular sesaon games, so let $n=82$. Shaq played in an average of 63.6 games, so let $p=\frac{64.25}{82}=0.784$. Shaq played in about 78% of the games during his career with the Lakers.

For the number of free throw attempts per game, we could model this as a Poisson random variable or a Negative Binomial random variable. As noted in the previous chapter, the variance of Shaq's FT attempts is a fair bit greater than the mean which means that it is overdispersed. Negative Binomial may be a more appropriate model than a Poisson. From last chapter, we found $\hat{r}=25.85$ and $\hat{p}=0.305$.

```{r}
set.seed(2020)
n.sims <- 10000
FT <- rep(0,n.sims)

# simulate the number of games played in a season, round to a whole number
games.sim <- rbinom(n = n.sims,size = 82,prob = 0.784)

# number of games can't exceed 82 games (regular season total)
games.sim[games.sim>82] = 82

for(i in 1:n.sims){
  # simulate the season total FT attempts in each simulation
  temp <- rnbinom(n = games.sim[i],size = 25.85,prob = 1-0.305)
  FT[i] <- sum(temp)
}

# Simulated mean and SD of season totals of free throw attempts
c(mean(FT),sd(FT))

# Actual mean and SD of season totals of free throw attempts
FT.actual <- c(479, 681, 498, 824, 972, 712, 725, 676)
FT.actual.mean <- mean(FT.actual)
FT.actual.var <- var(FT.actual) * 7/8 # population variance
FT.actual.sd <- sqrt(FT.actual.var)
c(FT.actual.mean,FT.actual.sd)

FT %>% as.data.frame() %>% 
  ggplot(aes(x=FT)) + 
  geom_histogram(bins=30,color = "yellow", fill = "purple") +
  ggtitle("Simulated Season FT Attempt Totals by Shaq with Lakers")
```

Notice that the mean of our simulation is somewhat close to Shaq's true season average number of free throw attempts but the variance of the simulation is far too low. 

We can also simulate data using resampling. In this case, rather than simulating random variables according to a distribution, we can use our actual data as a sampling distribution.

:::{.example}
Using resampling, simulate the number of free throws Shaq would attempt while with the Lakers. Compare the mean and variance of the simulation to Shaq's actual statistics.
:::

```{r, message=F}
set.seed(2020)
n.sims <- 10000
FT <- rep(0,n.sims)
shaq.games <- c(51,60,49,79,74,67,67,67)
shaq.FTA <- read_csv("data/shaqFT.csv", col_names = FALSE)
shaq.FTA <- shaq.FTA$X1

# sample (with replacement) from Shaq's FTA game totals
games.sim <- sample(x = shaq.games,size = n.sims,replace = T)

for(i in 1:n.sims){
  # sample (with replacement) from Shaq's FTA game totals
  temp <- sample(x = shaq.FTA,size = games.sim[i],replace = T)
  FT[i] <- sum(temp)
}

# Simulated mean and SD of season totals of free throw attempts
c(mean(FT),sd(FT))

# Actual mean and SD of season totals of free throw attempts
FT.actual <- c(479, 681, 498, 824, 972, 712, 725, 676)
FT.actual.mean <- mean(FT.actual)
FT.actual.var <- var(FT.actual) * 7/8 # population variance
FT.actual.sd <- sqrt(FT.actual.var)
c(FT.actual.mean,FT.actual.sd)

FT %>% as.data.frame() %>% 
  ggplot(aes(x=FT)) + 
  geom_histogram(bins=30,color = "yellow", fill = "purple") +
  ggtitle("Simulated Season FT Attempt Totals by Shaq with Lakers")
```

This simulation is biased low on the variance but is better than the earlier simulation.

One reason that you may want to do complicated simulations like the example above is to make predictions for a player's future seasons.

